{% extends 'board/base.html' %}
{% block content %}
<h2>Task Board</h2>

<div class="mb-3">
    <a href="{% url 'task_create' %}" class="btn btn-success">âž• Create Task</a>
</div>

<form method="get" class="mb-3">
    <div class="d-flex flex-wrap align-items-end gap-3">
        <div class="d-flex flex-wrap gap-3">
            <div>
                {{ form.assignee.label_tag }} {{ form.assignee }}
            </div>
            <div>
                {{ form.author.label_tag }} {{ form.author }}
            </div>
            <div>
                {{ form.start_date.label_tag }} {{ form.start_date }}
            </div>
            <div>
                {{ form.end_date.label_tag }} {{ form.end_date }}
            </div>
            <div>
                {{ form.status.label_tag }} {{ form.status }}
            </div>
            <div class="form-check mt-4">
                {{ form.show_only_mine }} {{ form.show_only_mine.label_tag }}
            </div>
        </div>


        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <a href="{% url 'task_board' %}" class="btn btn-secondary">Reset Filters</a>
            <a href="{% url 'generate_report' %}?{{ request.GET.urlencode }}" class="btn btn-success">Generate
                Report</a>
        </div>
    </div>
</form>

<div class="d-flex justify-content-between">
    {% for pair in status_columns %}
    {% with status=pair.0 label=pair.1 %}
    <div class="border p-2 m-2 rounded bg-light" style="width: 32%;">
        <h5>{{ label }}</h5>
        <div class="task-column" data-status="{{ status }}" style="min-height: 200px;">
            {% for task in tasks %}
            {% if task.status == status %}
            <div class="card p-2 mb-2 task-card" data-id="{{ task.id }}" draggable="true">
                <strong>{{ task.title }}</strong><br>
                <small>By {{ task.author.username }}</small><br>
                <div class="mt-2 d-flex gap-1">
                    <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-primary">View</a>
                    {% if task.author == request.user %}
                    <a href="{% url 'task_update' task.id %}" class="btn btn-sm btn-secondary">Edit</a>
                    <a href="{% url 'task_delete' task.id %}" class="btn btn-sm btn-danger">Delete</a>
                    {% endif %}

                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endwith %}
    {% endfor %}
</div>

<script>
    const cards = document.querySelectorAll('.task-card');
    const columns = document.querySelectorAll('.task-column');

    cards.forEach(card => {
        card.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', card.dataset.id);
        });
    });

    columns.forEach(column => {
        column.addEventListener('dragover', e => e.preventDefault());
        column.addEventListener('drop', e => {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = column.dataset.status;
            const card = document.querySelector(`[data-id='${taskId}']`);
            column.appendChild(card);

            fetch("{% url 'update_task_status' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `task_id=${taskId}&status=${newStatus}`
            });
        });
    });
</script>
{% endblock %}
